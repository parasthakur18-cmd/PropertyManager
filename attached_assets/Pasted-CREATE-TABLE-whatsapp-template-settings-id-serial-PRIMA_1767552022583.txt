CREATE TABLE "whatsapp_template_settings" (
	"id" serial PRIMARY KEY NOT NULL,
	"property_id" integer NOT NULL,
	"template_type" varchar(50) NOT NULL,
	"is_enabled" boolean DEFAULT true NOT NULL,
	"send_timing" varchar(20) DEFAULT 'immediate' NOT NULL,
	"delay_hours" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "whatsapp_template_settings_property_id_template_type_key" UNIQUE("property_id","template_type")
);
CREATE TABLE "user_sessions" (
	"id" serial PRIMARY KEY NOT NULL,
	"user_id" varchar NOT NULL,
	"session_token" varchar(255) NOT NULL,
	"device_info" varchar(255),
	"browser" varchar(100),
	"os" varchar(100),
	"ip_address" varchar(50),
	"location" varchar(255),
	"is_active" boolean DEFAULT true NOT NULL,
	"last_activity_at" timestamp DEFAULT now(),
	"expires_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "user_sessions_session_token_key" UNIQUE("session_token")
);
CREATE TABLE "activity_logs" (
	"id" serial PRIMARY KEY NOT NULL,
	"user_id" varchar,
	"user_email" varchar(255),
	"user_name" varchar(255),
	"action" varchar(100) NOT NULL,
	"category" varchar(50) NOT NULL,
	"resource_type" varchar(50),
	"resource_id" varchar(100),
	"resource_name" varchar(255),
	"property_id" integer,
	"property_name" varchar(255),
	"details" jsonb,
	"ip_address" varchar(50),
	"user_agent" text,
	"created_at" timestamp DEFAULT now()
);
CREATE TABLE "subscription_payments" (
	"id" serial PRIMARY KEY NOT NULL,
	"subscription_id" integer NOT NULL,
	"user_id" varchar NOT NULL,
	"amount" numeric(10, 2) NOT NULL,
	"currency" varchar(10) DEFAULT 'INR' NOT NULL,
	"status" varchar(30) DEFAULT 'pending' NOT NULL,
	"razorpay_payment_id" varchar(100),
	"razorpay_order_id" varchar(100),
	"invoice_number" varchar(50),
	"invoice_url" text,
	"paid_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
CREATE TABLE "user_subscriptions" (
	"id" serial PRIMARY KEY NOT NULL,
	"user_id" varchar NOT NULL,
	"plan_id" integer NOT NULL,
	"status" varchar(30) DEFAULT 'active' NOT NULL,
	"billing_cycle" varchar(20) DEFAULT 'monthly' NOT NULL,
	"start_date" timestamp DEFAULT now() NOT NULL,
	"end_date" timestamp,
	"trial_ends_at" timestamp,
	"cancelled_at" timestamp,
	"razorpay_subscription_id" varchar(100),
	"razorpay_customer_id" varchar(100),
	"last_payment_at" timestamp,
	"next_billing_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
CREATE TABLE "subscription_plans" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" varchar(100) NOT NULL,
	"slug" varchar(50) NOT NULL,
	"description" text,
	"monthly_price" numeric(10, 2) DEFAULT '0' NOT NULL,
	"yearly_price" numeric(10, 2),
	"max_properties" integer DEFAULT 1 NOT NULL,
	"max_rooms" integer DEFAULT 10 NOT NULL,
	"max_staff" integer DEFAULT 2,
	"features" jsonb DEFAULT '[]'::jsonb,
	"is_active" boolean DEFAULT true NOT NULL,
	"display_order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "subscription_plans_slug_key" UNIQUE("slug")
);
CREATE TABLE "beds24_room_mappings" (
	"id" serial PRIMARY KEY NOT NULL,
	"property_id" integer NOT NULL,
	"beds24_room_id" varchar(50) NOT NULL,
	"room_type" varchar(100) NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"beds24_room_name" varchar(255),
	CONSTRAINT "beds24_room_mappings_property_id_beds24_room_id_key" UNIQUE("property_id","beds24_room_id")
);
ALTER TABLE "password_reset_otps" ADD COLUMN "reset_token" varchar(100);
truncate table "pre_bills" cascade;
ALTER TABLE "pre_bills" ADD COLUMN "token" varchar(64) NOT NULL;
ALTER TABLE "pre_bills" ADD COLUMN "room_charges" numeric(10, 2) DEFAULT '0';
ALTER TABLE "pre_bills" ADD COLUMN "food_charges" numeric(10, 2) DEFAULT '0';
ALTER TABLE "pre_bills" ADD COLUMN "extra_charges" numeric(10, 2) DEFAULT '0';
ALTER TABLE "pre_bills" ADD COLUMN "gst_amount" numeric(10, 2) DEFAULT '0';
ALTER TABLE "pre_bills" ADD COLUMN "discount" numeric(10, 2) DEFAULT '0';
ALTER TABLE "pre_bills" ADD COLUMN "advance_payment" numeric(10, 2) DEFAULT '0';
ALTER TABLE "pre_bills" ADD COLUMN "food_items" jsonb;
ALTER TABLE "pre_bills" ADD COLUMN "guest_name" varchar(255);
ALTER TABLE "pre_bills" ADD COLUMN "guest_phone" varchar(20);
ALTER TABLE "pre_bills" ADD COLUMN "guest_email" varchar(255);
ALTER TABLE "pre_bills" ADD COLUMN "property_id" integer;
ALTER TABLE "pre_bills" ADD COLUMN "check_in_date" date;
ALTER TABLE "pre_bills" ADD COLUMN "check_out_date" date;
ALTER TABLE "pre_bills" ADD COLUMN "nights" integer DEFAULT 1;
ALTER TABLE "properties" ADD COLUMN "monthly_rent" numeric(10, 2);
ALTER TABLE "staff_members" ADD COLUMN "leaving_date" timestamp;
ALTER TABLE "feature_settings" ADD COLUMN "advance_payment_enabled" boolean DEFAULT true NOT NULL;
ALTER TABLE "feature_settings" ADD COLUMN "advance_payment_percentage" numeric(5, 2) DEFAULT '30';
ALTER TABLE "feature_settings" ADD COLUMN "advance_payment_expiry_hours" integer DEFAULT 24;
ALTER TABLE "feature_settings" ADD COLUMN "payment_reminder_enabled" boolean DEFAULT true;
ALTER TABLE "feature_settings" ADD COLUMN "payment_reminder_hours" integer DEFAULT 6;
ALTER TABLE "feature_settings" ADD COLUMN "max_payment_reminders" integer DEFAULT 3;
ALTER TABLE "users" ADD COLUMN "city" varchar(100);
ALTER TABLE "users" ADD COLUMN "state" varchar(100);
ALTER TABLE "users" ADD COLUMN "country" varchar(100);
ALTER TABLE "users" ADD COLUMN "last_login_ip" varchar(45);
ALTER TABLE "users" ADD COLUMN "last_login_at" timestamp;
ALTER TABLE "users" ADD COLUMN "subscription_plan_id" integer;
ALTER TABLE "users" ADD COLUMN "subscription_status" varchar(20) DEFAULT 'trial';
ALTER TABLE "users" ADD COLUMN "subscription_start_date" timestamp;
ALTER TABLE "users" ADD COLUMN "subscription_end_date" timestamp;
ALTER TABLE "users" ADD COLUMN "razorpay_subscription_id" varchar(100);
ALTER TABLE "users" ADD COLUMN "razorpay_customer_id" varchar(100);
ALTER TABLE "users" ADD COLUMN "trial_ends_at" timestamp;
ALTER TABLE "bookings" ADD COLUMN "payment_link_id" varchar(100);
ALTER TABLE "bookings" ADD COLUMN "payment_link_url" text;
ALTER TABLE "bookings" ADD COLUMN "payment_link_expiry" timestamp;
ALTER TABLE "bookings" ADD COLUMN "advance_payment_status" varchar(20) DEFAULT 'not_required';
ALTER TABLE "bookings" ADD COLUMN "reminder_count" integer DEFAULT 0;
ALTER TABLE "bookings" ADD COLUMN "last_reminder_at" timestamp;
ALTER TABLE "bookings" ADD COLUMN "external_booking_id" varchar(100);
ALTER TABLE "bookings" ADD COLUMN "external_source" varchar(50);
ALTER TABLE "whatsapp_template_settings" ADD CONSTRAINT "whatsapp_template_settings_property_id_fkey" FOREIGN KEY ("property_id") REFERENCES "public"."properties"("id") ON DELETE cascade ON UPDATE no action;
ALTER TABLE "user_sessions" ADD CONSTRAINT "user_sessions_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;
ALTER TABLE "activity_logs" ADD CONSTRAINT "activity_logs_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;
ALTER TABLE "activity_logs" ADD CONSTRAINT "activity_logs_property_id_fkey" FOREIGN KEY ("property_id") REFERENCES "public"."properties"("id") ON DELETE set null ON UPDATE no action;
ALTER TABLE "subscription_payments" ADD CONSTRAINT "subscription_payments_subscription_id_fkey" FOREIGN KEY ("subscription_id") REFERENCES "public"."user_subscriptions"("id") ON DELETE no action ON UPDATE no action;
ALTER TABLE "subscription_payments" ADD CONSTRAINT "subscription_payments_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;
ALTER TABLE "user_subscriptions" ADD CONSTRAINT "user_subscriptions_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;
ALTER TABLE "user_subscriptions" ADD CONSTRAINT "user_subscriptions_plan_id_fkey" FOREIGN KEY ("plan_id") REFERENCES "public"."subscription_plans"("id") ON DELETE no action ON UPDATE no action;
ALTER TABLE "beds24_room_mappings" ADD CONSTRAINT "beds24_room_mappings_property_id_fkey" FOREIGN KEY ("property_id") REFERENCES "public"."properties"("id") ON DELETE no action ON UPDATE no action;
CREATE INDEX "idx_user_sessions_is_active" ON "user_sessions" USING btree ("is_active");
CREATE INDEX "idx_user_sessions_user_id" ON "user_sessions" USING btree ("user_id");
CREATE INDEX "idx_activity_logs_category" ON "activity_logs" USING btree ("category");
CREATE INDEX "idx_activity_logs_created_at" ON "activity_logs" USING btree ("created_at");
CREATE INDEX "idx_activity_logs_property_id" ON "activity_logs" USING btree ("property_id");
CREATE INDEX "idx_activity_logs_user_id" ON "activity_logs" USING btree ("user_id");
ALTER TABLE "pre_bills" ADD CONSTRAINT "pre_bills_property_id_fkey" FOREIGN KEY ("property_id") REFERENCES "public"."properties"("id") ON DELETE no action ON UPDATE no action;